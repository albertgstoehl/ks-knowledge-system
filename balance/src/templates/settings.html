{% extends "base.html" %}

{% block title %}Balance - Settings{% endblock %}

{% block content %}
<main class="main">
  <div class="container">
    <header class="page-header">
      <h1>Settings</h1>
    </header>

    <form id="settings-form">
      <div class="settings-section">
        <div class="settings-title">Timer</div>
        <div class="setting-row">
          <span class="setting-label">Session duration</span>
          <div class="setting-value">
            <input type="number" class="setting-input" id="session-duration" min="1" max="60">
            <span class="setting-unit">min</span>
          </div>
        </div>
        <div class="setting-row">
          <span class="setting-label">Short break</span>
          <div class="setting-value">
            <input type="number" class="setting-input" id="short-break" min="1" max="30">
            <span class="setting-unit">min</span>
          </div>
        </div>
        <div class="setting-row">
          <span class="setting-label">Long break</span>
          <div class="setting-value">
            <input type="number" class="setting-input" id="long-break" min="5" max="60">
            <span class="setting-unit">min</span>
          </div>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-title">Limits</div>
        <div class="setting-row">
          <span class="setting-label">Daily cap</span>
          <div class="setting-value">
            <input type="number" class="setting-input" id="daily-cap" min="1" max="20">
            <span class="setting-unit">sessions</span>
          </div>
        </div>
        <div class="setting-row">
          <span class="setting-label">Hard maximum</span>
          <div class="setting-value">
            <input type="number" class="setting-input" id="hard-max" min="1" max="24">
            <span class="setting-unit">sessions</span>
          </div>
        </div>
        <div class="setting-row">
          <span class="setting-label">Evening cutoff</span>
          <div class="setting-value">
            <input type="time" class="setting-input" id="evening-cutoff" style="width: 90px;">
          </div>
        </div>
        <div class="setting-row">
          <span class="setting-label">Rabbit hole check</span>
          <div class="setting-value">
            <input type="number" class="setting-input" id="rabbit-hole-check" min="2" max="10">
            <span class="setting-unit">sessions</span>
          </div>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-title">North Star</div>
        <textarea class="north-star-input" id="north-star" placeholder="What matters most to you?"></textarea>
      </div>

      <button type="submit" class="btn btn-primary btn-full">Save Settings</button>
    </form>

    <div id="save-status" style="text-align: center; margin-top: 1rem; font-size: 0.875rem; color: var(--color-muted);"></div>
  </div>
</main>
{% endblock %}

{% block scripts %}
<script>
const Settings = {
  init() {
    this.loadSettings();
    this.loadState();
    this.bindEvents();
  },

  bindEvents() {
    document.getElementById('settings-form').addEventListener('submit', (e) => {
      e.preventDefault();
      this.saveSettings();
    });
  },

  async loadSettings() {
    try {
      const settings = await fetch('/api/settings').then(r => r.json());
      document.getElementById('session-duration').value = settings.session_duration;
      document.getElementById('short-break').value = settings.short_break;
      document.getElementById('long-break').value = settings.long_break;
      document.getElementById('daily-cap').value = settings.daily_cap;
      document.getElementById('hard-max').value = settings.hard_max;
      document.getElementById('evening-cutoff').value = settings.evening_cutoff;
      document.getElementById('rabbit-hole-check').value = settings.rabbit_hole_check;
    } catch (err) {
      console.error('Failed to load settings:', err);
    }
  },

  async loadState() {
    try {
      const state = await fetch('/api/state').then(r => r.json());
      document.getElementById('north-star').value = state.north_star || '';
    } catch (err) {
      console.error('Failed to load state:', err);
    }
  },

  async saveSettings() {
    const statusEl = document.getElementById('save-status');
    statusEl.textContent = 'Saving...';

    try {
      // Save settings
      const settingsResponse = await fetch('/api/settings', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          session_duration: parseInt(document.getElementById('session-duration').value),
          short_break: parseInt(document.getElementById('short-break').value),
          long_break: parseInt(document.getElementById('long-break').value),
          daily_cap: parseInt(document.getElementById('daily-cap').value),
          hard_max: parseInt(document.getElementById('hard-max').value),
          evening_cutoff: document.getElementById('evening-cutoff').value,
          rabbit_hole_check: parseInt(document.getElementById('rabbit-hole-check').value)
        })
      });

      // Save north star
      const northStar = document.getElementById('north-star').value;
      if (northStar) {
        await fetch('/api/state/north-star', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ north_star: northStar })
        });
      }

      if (settingsResponse.ok) {
        statusEl.textContent = 'Settings saved';
        statusEl.style.color = '#090';
        setTimeout(() => {
          statusEl.textContent = '';
          statusEl.style.color = '';
        }, 2000);
      } else {
        throw new Error('Failed to save');
      }
    } catch (err) {
      console.error('Failed to save settings:', err);
      statusEl.textContent = 'Failed to save settings';
      statusEl.style.color = '#c00';
    }
  }
};

document.addEventListener('DOMContentLoaded', () => Settings.init());
</script>
{% endblock %}
