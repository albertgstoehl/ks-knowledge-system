<style>
.drift-alert {
  border: 2px solid var(--color-border);
  padding: 1.5rem;
  margin-bottom: 2rem;
}
.drift-alert__header {
  font-size: var(--font-size-xs);
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--color-muted);
  margin-bottom: 0.5rem;
}
.drift-alert__main {
  font-size: var(--font-size-lg);
  line-height: 1.5;
}
.drift-alert__context {
  font-size: var(--font-size-sm);
  color: var(--color-muted);
  padding-top: 1rem;
  margin-top: 1rem;
  border-top: 1px solid var(--color-border-light);
}
.drift-alert__stat {
  display: inline-block;
  padding: 0.25rem 0.5rem;
  border: 1px solid var(--color-border);
  margin: 0 0.25rem;
  font-variant-numeric: tabular-nums;
}
</style>

<div class="container">
    <div id="drift-alert" class="drift-alert" style="display: none;">
      <div class="drift-alert__header">Biggest drift</div>
      <div class="drift-alert__main" id="drift-main"></div>
      <div class="drift-alert__context" id="drift-context"></div>
    </div>

    <div class="button-group period-selector">
      <button class="btn btn--option active" data-period="week">Week</button>
      <button class="btn btn--option" data-period="month">Month</button>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="value" id="stat-sessions">0</div>
        <div class="label">Sessions</div>
      </div>
      <div class="stat-card">
        <div class="value" id="stat-expected">0</div>
        <div class="label">Expected</div>
      </div>
      <div class="stat-card">
        <div class="value" id="stat-personal">0</div>
        <div class="label">Personal</div>
      </div>
      <div class="stat-card">
        <div class="value" id="stat-meditation">0m</div>
        <div class="label">Meditation</div>
      </div>
      <div class="stat-card">
        <div class="value" id="stat-exercise">0m</div>
        <div class="label">Exercise</div>
      </div>
      <div class="stat-card">
        <div class="value" id="stat-focus">-</div>
        <div class="label">Focus Rate</div>
      </div>
    </div>

    <div class="compass-section">
      <div class="compass-title">Life Compass</div>
      <div class="compass-grid">
        <div class="compass-item">
          <div class="name">Focus</div>
          <div class="status" id="compass-focus">-</div>
        </div>
        <div class="compass-item">
          <div class="name">Body</div>
          <div class="status" id="compass-body">-</div>
        </div>
        <div class="compass-item">
          <div class="name">Connection</div>
          <div class="status" id="compass-connection">-</div>
        </div>
        <div class="compass-item">
          <div class="name">Mood</div>
          <div class="status" id="compass-mood">-</div>
        </div>
      </div>
    </div>

    <div class="north-star-section" style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--color-border);">
      <div class="compass-title">North Star</div>
      <p id="north-star" style="font-size: 0.875rem; line-height: 1.6; color: var(--color-muted); text-align: center;">-</p>
  </div>
</div>
<script>
(function() {
const Stats = {
  period: 'week',

  init() {
    this.bindEvents();
    this.loadStats();
    this.loadNorthStar();
    this.loadDrift();
  },

  bindEvents() {
    document.querySelectorAll('.period-selector .btn--option').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.period-selector .btn--option').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        this.period = btn.dataset.period;
        this.loadStats();
      });
    });
  },

  async loadStats() {
    try {
      const endpoint = this.period === 'week' ? '/api/stats/week' : '/api/stats/month';
      const stats = await fetch(endpoint).then(r => r.json());

      document.getElementById('stat-sessions').textContent = stats.session_count || 0;
      document.getElementById('stat-expected').textContent = stats.expected_sessions || 0;
      document.getElementById('stat-personal').textContent = stats.personal_sessions || 0;
      document.getElementById('stat-meditation').textContent = `${stats.meditation_minutes || 0}m`;
      document.getElementById('stat-exercise').textContent = `${stats.exercise_minutes || 0}m`;

      document.getElementById('stat-focus').textContent = '-';

      this.updateCompass(stats);
    } catch (err) {
      console.error('Failed to load stats:', err);
    }
  },

  updateCompass(stats) {
    const sessionGoal = this.period === 'week' ? 35 : 140;
    const focusPercent = Math.min(100, Math.round((stats.session_count / sessionGoal) * 100));
    document.getElementById('compass-focus').textContent = focusPercent > 0 ? `${focusPercent}%` : '-';

    const bodyMinutes = (stats.meditation_minutes || 0) + (stats.exercise_minutes || 0);
    const bodyGoal = this.period === 'week' ? 150 : 600;
    const bodyPercent = Math.min(100, Math.round((bodyMinutes / bodyGoal) * 100));
    document.getElementById('compass-body').textContent = bodyPercent > 0 ? `${bodyPercent}%` : '-';

    document.getElementById('compass-connection').textContent = '-';
    document.getElementById('compass-mood').textContent = '-';
  },

  async loadNorthStar() {
    try {
      const state = await fetch('/api/state').then(r => r.json());
      document.getElementById('north-star').textContent = state.north_star || 'Not set';
    } catch (err) {
      console.error('Failed to load north star:', err);
    }
  },

  async loadDrift() {
    try {
      const data = await fetch('/api/stats/drift').then(r => r.json());

      const alert = document.getElementById('drift-alert');
      if (data.biggest_drift) {
        const d = data.biggest_drift;
        document.getElementById('drift-main').innerHTML = `
          <strong>${d.priority}</strong> is priority #${d.rank} but got
          <span class="drift-alert__stat">${d.pct}%</span> of sessions.
          <strong>${d.instead}</strong> (#${d.instead_rank}) got
          <span class="drift-alert__stat">${d.instead_pct}%</span>.
        `;
        document.getElementById('drift-context').textContent =
          data.weeks_drifting > 1
            ? `This is week ${data.weeks_drifting} of ${d.priority} being deprioritized.`
            : '';
        alert.style.display = 'block';
      } else {
        alert.style.display = 'none';
      }
    } catch (err) {
      console.error('Failed to load drift:', err);
    }
  }
};

// Run immediately - DOM already ready when htmx swaps content
Stats.init();
})();
</script>
