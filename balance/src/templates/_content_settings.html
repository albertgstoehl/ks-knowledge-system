<div class="container">
    <form id="settings-form">
      <div class="settings-section">
        <div class="settings-title">Priorities</div>
        <p class="text-muted text-sm mb-md">Use arrows to reorder. Expected sessions must be tagged to a priority.</p>

        <div class="priority-list" id="priority-list">
          <!-- Populated by JS -->
        </div>

        <div class="mt-md" id="add-priority-form" style="display: none;">
          <input type="text" class="input" id="new-priority-name" placeholder="Priority name" maxlength="30">
          <div class="button-group mt-sm">
            <button type="button" class="btn btn--primary" onclick="PriorityManager.save()">Add</button>
            <button type="button" class="btn" onclick="PriorityManager.hideAddForm()">Cancel</button>
          </div>
        </div>

        <button type="button" class="btn btn--full mt-md" id="add-priority-btn" onclick="PriorityManager.showAddForm()">+ Add Priority</button>
        <p class="text-muted text-xs mt-sm" id="priority-limit-msg" style="display: none;">Max 4 priorities</p>
      </div>

      <div class="settings-section">
        <div class="settings-title">Timer</div>
        <div class="setting-row">
          <span class="setting-label">Session duration</span>
          <div class="setting-value">
            <input type="number" class="setting-input" id="session-duration" min="1" max="60">
            <span class="setting-unit">min</span>
          </div>
        </div>
        <div class="setting-row">
          <span class="setting-label">Short break</span>
          <div class="setting-value">
            <input type="number" class="setting-input" id="short-break" min="1" max="30">
            <span class="setting-unit">min</span>
          </div>
        </div>
        <div class="setting-row">
          <span class="setting-label">Long break</span>
          <div class="setting-value">
            <input type="number" class="setting-input" id="long-break" min="5" max="60">
            <span class="setting-unit">min</span>
          </div>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-title">Limits</div>
        <div class="setting-row">
          <span class="setting-label">Daily cap</span>
          <div class="setting-value">
            <input type="number" class="setting-input" id="daily-cap" min="1" max="20">
            <span class="setting-unit">sessions</span>
          </div>
        </div>
        <div class="setting-row">
          <span class="setting-label">Hard maximum</span>
          <div class="setting-value">
            <input type="number" class="setting-input" id="hard-max" min="1" max="24">
            <span class="setting-unit">sessions</span>
          </div>
        </div>
        <div class="setting-row">
          <span class="setting-label">Evening cutoff</span>
          <div class="setting-value">
            <input type="time" class="setting-input" id="evening-cutoff" style="width: 90px;">
          </div>
        </div>
        <div class="setting-row">
          <span class="setting-label">Rabbit hole check</span>
          <div class="setting-value">
            <input type="number" class="setting-input" id="rabbit-hole-check" min="2" max="10">
            <span class="setting-unit">sessions</span>
          </div>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-title">North Star</div>
        <textarea class="north-star-input" id="north-star" placeholder="What matters most to you?"></textarea>
      </div>

      <button type="submit" class="btn btn--primary btn--full">Save Settings</button>
    </form>

  <div id="save-status" style="text-align: center; margin-top: 1rem; font-size: 0.875rem; color: var(--color-muted);"></div>
</div>
<script>
(function() {
const PriorityManager = {
  priorities: [],

  async init() {
    await this.load();
    this.render();
  },

  async load() {
    const response = await fetch('/api/priorities');
    this.priorities = await response.json();
  },

  render() {
    const list = document.getElementById('priority-list');
    const addBtn = document.getElementById('add-priority-btn');
    const limitMsg = document.getElementById('priority-limit-msg');

    if (this.priorities.length === 0) {
      list.innerHTML = '<div class="empty-state"><div class="empty-state__message">No priorities yet</div></div>';
    } else {
      list.innerHTML = this.priorities.map((p, i) => `
        <div class="priority-list__item" data-id="${p.id}">
          <span class="priority-list__rank">${p.rank}</span>
          <span class="priority-list__name">${p.name}</span>
          <span class="priority-list__meta">${p.session_count} sessions</span>
          <span class="priority-list__arrows">
            <button type="button" class="priority-list__arrow" onclick="PriorityManager.move(${p.id}, 'up')" ${i === 0 ? 'disabled' : ''}>&#9650;</button>
            <button type="button" class="priority-list__arrow" onclick="PriorityManager.move(${p.id}, 'down')" ${i === this.priorities.length - 1 ? 'disabled' : ''}>&#9660;</button>
          </span>
        </div>
      `).join('');
    }

    // Hide add button if at max
    if (this.priorities.length >= 4) {
      addBtn.style.display = 'none';
      limitMsg.style.display = 'block';
    } else {
      addBtn.style.display = 'block';
      limitMsg.style.display = this.priorities.length >= 3 ? 'block' : 'none';
    }
  },

  async move(id, direction) {
    const index = this.priorities.findIndex(p => p.id === id);
    const newIndex = direction === 'up' ? index - 1 : index + 1;

    if (newIndex < 0 || newIndex >= this.priorities.length) return;

    // Swap in local array
    [this.priorities[index], this.priorities[newIndex]] =
    [this.priorities[newIndex], this.priorities[index]];

    // Update ranks
    const order = this.priorities.map(p => p.id);
    await fetch('/api/priorities/reorder', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ order })
    });

    await this.load();
    this.render();
  },

  async add(name) {
    await fetch('/api/priorities', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name })
    });
    await this.load();
    this.render();
  },

  showAddForm() {
    document.getElementById('add-priority-form').style.display = 'block';
    document.getElementById('add-priority-btn').style.display = 'none';
    document.getElementById('new-priority-name').focus();
  },

  hideAddForm() {
    document.getElementById('add-priority-form').style.display = 'none';
    document.getElementById('add-priority-btn').style.display = 'block';
    document.getElementById('new-priority-name').value = '';
  },

  async save() {
    const name = document.getElementById('new-priority-name').value.trim();
    if (name) {
      await this.add(name);
      this.hideAddForm();
    }
  }
};

// Make PriorityManager globally accessible for onclick handlers
window.PriorityManager = PriorityManager;

const Settings = {
  init() {
    this.loadSettings();
    this.loadState();
    this.bindEvents();
    PriorityManager.init();
  },

  bindEvents() {
    document.getElementById('settings-form').addEventListener('submit', (e) => {
      e.preventDefault();
      this.saveSettings();
    });
  },

  async loadSettings() {
    try {
      const settings = await fetch('/api/settings').then(r => r.json());
      document.getElementById('session-duration').value = settings.session_duration;
      document.getElementById('short-break').value = settings.short_break;
      document.getElementById('long-break').value = settings.long_break;
      document.getElementById('daily-cap').value = settings.daily_cap;
      document.getElementById('hard-max').value = settings.hard_max;
      document.getElementById('evening-cutoff').value = settings.evening_cutoff;
      document.getElementById('rabbit-hole-check').value = settings.rabbit_hole_check;
    } catch (err) {
      console.error('Failed to load settings:', err);
    }
  },

  async loadState() {
    try {
      const state = await fetch('/api/state').then(r => r.json());
      document.getElementById('north-star').value = state.north_star || '';
    } catch (err) {
      console.error('Failed to load state:', err);
    }
  },

  async saveSettings() {
    const statusEl = document.getElementById('save-status');
    statusEl.textContent = 'Saving...';

    try {
      const settingsResponse = await fetch('/api/settings', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          session_duration: parseInt(document.getElementById('session-duration').value),
          short_break: parseInt(document.getElementById('short-break').value),
          long_break: parseInt(document.getElementById('long-break').value),
          daily_cap: parseInt(document.getElementById('daily-cap').value),
          hard_max: parseInt(document.getElementById('hard-max').value),
          evening_cutoff: document.getElementById('evening-cutoff').value,
          rabbit_hole_check: parseInt(document.getElementById('rabbit-hole-check').value)
        })
      });

      const northStar = document.getElementById('north-star').value;
      if (northStar) {
        await fetch('/api/state/north-star', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ north_star: northStar })
        });
      }

      if (settingsResponse.ok) {
        statusEl.textContent = 'Settings saved';
        statusEl.style.color = '#090';
        setTimeout(() => {
          statusEl.textContent = '';
          statusEl.style.color = '';
        }, 2000);
      } else {
        throw new Error('Failed to save');
      }
    } catch (err) {
      console.error('Failed to save settings:', err);
      statusEl.textContent = 'Failed to save settings';
      statusEl.style.color = '#c00';
    }
  }
};

// Run immediately - DOM already ready when htmx swaps content
Settings.init();
})();
</script>
