<script>
(function() {
    const API_BASE = '/feeds';

    // Toggle feed section
    window.toggleFeed = function(feedId) {
        const items = document.getElementById('feed-items-' + feedId);
        const section = items.closest('.feed-section');
        const toggle = section.querySelector('.feed-toggle');

        if (items.style.display === 'none') {
            items.style.display = 'block';
            toggle.innerHTML = '&#9660;';
        } else {
            items.style.display = 'none';
            toggle.innerHTML = '&#9654;';
        }
    };

    // Show feed menu
    window.showFeedMenu = function(feedId, currentTitle) {
        const action = prompt('Enter action:\n1. Rename\n2. Unsubscribe\n\nOr press Cancel');
        if (action === '1') {
            const newTitle = prompt('New name:', currentTitle);
            if (newTitle && newTitle !== currentTitle) {
                renameFeed(feedId, newTitle);
            }
        } else if (action === '2') {
            if (confirm('Unsubscribe from this feed?')) {
                deleteFeed(feedId);
            }
        }
    };

    // Rename feed
    async function renameFeed(feedId, newTitle) {
        try {
            const res = await fetch(`${API_BASE}/${feedId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title: newTitle })
            });
            if (res.ok) {
                location.reload();
            }
        } catch (err) {
            console.error('Failed to rename feed:', err);
        }
    }

    // Delete feed
    async function deleteFeed(feedId) {
        try {
            const res = await fetch(`${API_BASE}/${feedId}`, { method: 'DELETE' });
            if (res.ok) {
                document.querySelector(`[data-feed-id="${feedId}"]`).remove();
            }
        } catch (err) {
            console.error('Failed to delete feed:', err);
        }
    }

    // Add feed
    document.getElementById('add-feed-btn').addEventListener('click', async function() {
        const input = document.getElementById('feed-url-input');
        const url = input.value.trim();
        if (!url) return;

        try {
            const res = await fetch(API_BASE, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: url })
            });
            if (res.ok) {
                location.reload();
            } else {
                const data = await res.json();
                alert(data.detail || 'Failed to add feed');
            }
        } catch (err) {
            console.error('Failed to add feed:', err);
            alert('Failed to add feed');
        }
    });

    // Enter key to add feed
    document.getElementById('feed-url-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            document.getElementById('add-feed-btn').click();
        }
    });

    // Render detail panel for feed item
    function renderFeedItemDetail(item) {
        const panel = document.getElementById('detail-panel');
        const data = item.dataset;

        panel.innerHTML = `
            <button class="btn back-btn" onclick="closeDetail()">Back</button>
            <h2 class="detail-title">${data.title}</h2>
            <p class="detail-description">${data.description || 'No description'}</p>
            <div class="detail-actions">
                <a href="${data.url}" target="_blank" class="btn btn-primary">Open</a>
                <button class="btn" onclick="saveItem(${data.feedId}, ${data.itemId})">Save to Bookmarks</button>
                <button class="btn btn-danger" onclick="dismissItem(${data.feedId}, ${data.itemId})">Dismiss</button>
            </div>
        `;
        panel.classList.add('active');
    }

    // Close detail
    window.closeDetail = function() {
        document.getElementById('detail-panel').classList.remove('active');
        document.querySelectorAll('.feed-item').forEach(el => el.classList.remove('selected'));
    };

    // Save item to bookmarks
    window.saveItem = async function(feedId, itemId) {
        try {
            const res = await fetch(`${API_BASE}/${feedId}/items/${itemId}/save`, {
                method: 'POST'
            });
            if (res.ok) {
                alert('Saved to bookmarks!');
                closeDetail();
            }
        } catch (err) {
            console.error('Failed to save item:', err);
        }
    };

    // Dismiss item
    window.dismissItem = async function(feedId, itemId) {
        try {
            const res = await fetch(`${API_BASE}/${feedId}/items/${itemId}`, {
                method: 'DELETE'
            });
            if (res.ok) {
                document.querySelector(`[data-item-id="${itemId}"]`).remove();
                closeDetail();
            }
        } catch (err) {
            console.error('Failed to dismiss item:', err);
        }
    };

    // Click handler for feed items
    document.getElementById('feed-list').addEventListener('click', function(e) {
        const item = e.target.closest('.feed-item');
        if (item) {
            document.querySelectorAll('.feed-item').forEach(el => el.classList.remove('selected'));
            item.classList.add('selected');
            renderFeedItemDetail(item);
        }
    });
})();
</script>
