{# ==========================================================================
   COMPONENT MACROS
   Reusable Jinja2 macros for all services

   Usage: {% import "components.html" as ui %}
   ========================================================================== #}


{# ==========================================================================
   BUTTON

   {{ ui.button("Save") }}
   {{ ui.button("Submit", primary=true) }}
   {{ ui.button("Delete", danger=true) }}
   {{ ui.button("Cancel", ghost=true) }}
   {{ ui.button("Full Width", primary=true, full=true) }}
   ========================================================================== #}
{% macro button(text, primary=false, danger=false, ghost=false, full=false, lg=false, sm=false, type="button", disabled=false, id=none, class=none) %}
<button
  type="{{ type }}"
  class="btn{% if primary %} btn--primary{% endif %}{% if danger %} btn--danger{% endif %}{% if ghost %} btn--ghost{% endif %}{% if full %} btn--full{% endif %}{% if lg %} btn--lg{% endif %}{% if sm %} btn--sm{% endif %}{% if class %} {{ class }}{% endif %}"
  {% if disabled %}disabled{% endif %}
  {% if id %}id="{{ id }}"{% endif %}
>{{ text }}</button>
{% endmacro %}


{# ==========================================================================
   LINK BUTTON

   {{ ui.link_button("Go Home", "/") }}
   {{ ui.link_button("Dashboard", "/dashboard", primary=true) }}
   ========================================================================== #}
{% macro link_button(text, href, primary=false, danger=false, full=false, class=none) %}
<a
  href="{{ href }}"
  class="btn{% if primary %} btn--primary{% endif %}{% if danger %} btn--danger{% endif %}{% if full %} btn--full{% endif %}{% if class %} {{ class }}{% endif %}"
>{{ text }}</a>
{% endmacro %}


{# ==========================================================================
   HEADER

   {{ ui.header("Balance") }}
   {{ ui.header("Balance", [("Timer", "/"), ("Log", "/log")], active="Timer") }}
   ========================================================================== #}
{% macro header(title, tabs=[], active=none) %}
<header class="header">
  <h1 class="header__title">{{ title }}</h1>
  {% if tabs %}
  <nav class="tabs">
    {% for label, url in tabs %}
    <a href="{{ url }}"
       class="tab{% if label == active %} tab--active{% endif %}"
       hx-get="{{ url }}"
       hx-target="#main-content"
       hx-swap="innerHTML"
       hx-push-url="true">{{ label }}</a>
    {% endfor %}
  </nav>
  {% endif %}
</header>
{% endmacro %}


{# ==========================================================================
   INPUT

   {{ ui.input("email", placeholder="Enter email") }}
   {{ ui.input("password", type="password", required=true) }}
   ========================================================================== #}
{% macro input(name, placeholder="", type="text", value="", required=false, id=none, class=none, autofocus=false) %}
<input
  type="{{ type }}"
  name="{{ name }}"
  {% if id %}id="{{ id }}"{% else %}id="{{ name }}"{% endif %}
  placeholder="{{ placeholder }}"
  value="{{ value }}"
  class="input{% if class %} {{ class }}{% endif %}"
  {% if required %}required{% endif %}
  {% if autofocus %}autofocus{% endif %}
>
{% endmacro %}


{# ==========================================================================
   TEXTAREA

   {{ ui.textarea("content", placeholder="Write something...") }}
   ========================================================================== #}
{% macro textarea(name, placeholder="", value="", rows=4, required=false, id=none) %}
<textarea
  name="{{ name }}"
  {% if id %}id="{{ id }}"{% else %}id="{{ name }}"{% endif %}
  placeholder="{{ placeholder }}"
  rows="{{ rows }}"
  class="textarea"
  {% if required %}required{% endif %}
>{{ value }}</textarea>
{% endmacro %}


{# ==========================================================================
   FORM GROUP

   {% call ui.form_group("Email", "email") %}
     {{ ui.input("email", placeholder="you@example.com") }}
   {% endcall %}
   ========================================================================== #}
{% macro form_group(label, for_id=none, help=none) %}
<div class="form-group">
  <label class="form-group__label" {% if for_id %}for="{{ for_id }}"{% endif %}>{{ label }}</label>
  {{ caller() }}
  {% if help %}
  <div class="form-group__help">{{ help }}</div>
  {% endif %}
</div>
{% endmacro %}


{# ==========================================================================
   CARD

   {% call ui.card() %}
     <p>Card content here</p>
   {% endcall %}

   {% call ui.card(hover=true) %}
     <p>Clickable card</p>
   {% endcall %}
   ========================================================================== #}
{% macro card(hover=false, class=none) %}
<div class="card{% if hover %} card--hover{% endif %}{% if class %} {{ class }}{% endif %}">
  {{ caller() }}
</div>
{% endmacro %}


{# ==========================================================================
   TABS (standalone, not in header)

   {{ ui.tabs([("Tab 1", "/tab1"), ("Tab 2", "/tab2")], active="Tab 1") }}
   ========================================================================== #}
{% macro tabs(items, active=none) %}
<nav class="tabs">
  {% for label, url in items %}
  <a href="{{ url }}" class="tab{% if label == active %} tab--active{% endif %}">{{ label }}</a>
  {% endfor %}
</nav>
{% endmacro %}


{# ==========================================================================
   BOTTOM NAV (mobile navigation with htmx)

   {{ ui.bottom_nav([("Timer", "/"), ("Log", "/log"), ("Stats", "/stats")], active="Timer") }}
   ========================================================================== #}
{% macro bottom_nav(items, active=none) %}
<nav class="bottom-nav">
  <div class="bottom-nav__links">
    {% for label, url in items %}
    <a href="{{ url }}"
       class="bottom-nav__link{% if label == active %} bottom-nav__link--active{% endif %}"
       hx-get="{{ url }}"
       hx-target="#main-content"
       hx-swap="innerHTML"
       hx-push-url="true">{{ label }}</a>
    {% endfor %}
  </div>
</nav>
{% endmacro %}


{# ==========================================================================
   PROGRESS BAR

   {{ ui.progress(75) }}
   {{ ui.progress(50, lg=true) }}
   ========================================================================== #}
{% macro progress(percent, lg=false) %}
<div class="progress{% if lg %} progress--lg{% endif %}">
  <div class="progress__fill" style="width: {{ percent }}%"></div>
</div>
{% endmacro %}


{# ==========================================================================
   EMPTY STATE

   {{ ui.empty_state("No bookmarks yet", "Add your first bookmark to get started") }}
   ========================================================================== #}
{% macro empty_state(title, message=none) %}
<div class="empty-state">
  <div class="empty-state__title">{{ title }}</div>
  {% if message %}
  <div class="empty-state__message">{{ message }}</div>
  {% endif %}
  {{ caller() if caller }}
</div>
{% endmacro %}


{# ==========================================================================
   LIST

   {% call ui.list() %}
     {% for item in items %}
       {{ ui.list_item(item.title, item.meta) }}
     {% endfor %}
   {% endcall %}
   ========================================================================== #}
{% macro list() %}
<div class="list">
  {{ caller() }}
</div>
{% endmacro %}

{% macro list_item(title, meta=none, selected=false) %}
<div class="list__item{% if selected %} list__item--selected{% endif %}">
  <div class="list__item-title">{{ title }}</div>
  {% if meta %}
  <div class="list__item-meta">{{ meta }}</div>
  {% endif %}
</div>
{% endmacro %}


{# ==========================================================================
   MODAL

   {% call ui.modal("Confirm Delete", id="delete-modal") %}
     <p>Are you sure?</p>
   {% endcall %}
   ========================================================================== #}
{% macro modal(title, id=none, hidden=true) %}
<div class="modal" {% if id %}id="{{ id }}"{% endif %} {% if hidden %}hidden{% endif %}>
  <div class="modal__content">
    <div class="modal__header">
      <span class="modal__title">{{ title }}</span>
      <button class="btn btn--ghost" onclick="this.closest('.modal').hidden = true">&times;</button>
    </div>
    <div class="modal__body">
      {{ caller() }}
    </div>
  </div>
</div>
{% endmacro %}


{# ==========================================================================
   LABEL

   {{ ui.label("Status") }}
   ========================================================================== #}
{% macro label(text) %}
<span class="label">{{ text }}</span>
{% endmacro %}


{# ==========================================================================
   ACCORDION

   {% call ui.accordion("Section Title", "section-id", count=5) %}
     <div>Accordion content here</div>
   {% endcall %}
   ========================================================================== #}
{% macro accordion(title, id, count=none, open=false) %}
<div class="accordion" data-accordion-id="{{ id }}">
  <div class="accordion__header" onclick="toggleAccordion('{{ id }}')">
    <span class="accordion__toggle" id="toggle-{{ id }}">{{ '▼' if open else '▶' }}</span>
    <span class="accordion__title">{{ title }}</span>
    {% if count is not none %}
    <span class="accordion__count">({{ count }})</span>
    {% endif %}
  </div>
  <div class="accordion__content {{ 'accordion__content--open' if open else '' }}" id="content-{{ id }}">
    {{ caller() }}
  </div>
</div>
{% endmacro %}


{# ==========================================================================
   DROPDOWN

   {% call ui.dropdown("Actions", "action-menu") %}
     {{ ui.dropdown_item("Edit", onclick="edit()") }}
     {{ ui.dropdown_item("Delete", onclick="delete()") }}
   {% endcall %}
   ========================================================================== #}
{% macro dropdown(trigger_text, id) %}
<div class="dropdown">
  <button class="btn" onclick="toggleDropdown('{{ id }}')">{{ trigger_text }} ▾</button>
  <div class="dropdown__menu" id="dropdown-{{ id }}">
    {{ caller() }}
  </div>
  <div class="dropdown__backdrop" id="backdrop-{{ id }}" onclick="closeDropdown('{{ id }}')"></div>
</div>
{% endmacro %}

{% macro dropdown_item(label, onclick=none, href=none) %}
{% if href %}
<a href="{{ href }}" class="dropdown__item">{{ label }}</a>
{% else %}
<button class="dropdown__item" onclick="{{ onclick }}">{{ label }}</button>
{% endif %}
{% endmacro %}


{# ==========================================================================
   VIDEO EMBED

   {{ ui.video_embed("dQw4w9WgXcQ", start=30) }}
   ========================================================================== #}
{% macro video_embed(video_id, start=0, id="yt-player") %}
<div class="video-embed">
  <iframe id="{{ id }}"
    src="https://www.youtube-nocookie.com/embed/{{ video_id }}?start={{ start }}&enablejsapi=1"
    frameborder="0"
    allowfullscreen
    allow="autoplay; fullscreen"
    class="video-embed__iframe">
  </iframe>
</div>
{% endmacro %}


{# ==========================================================================
   ACTION PANEL

   {% call ui.action_panel() %}
     {% call ui.action_row() %}
       {{ ui.button("Save", primary=true) }}
       {{ ui.button("Cancel") }}
     {% endcall %}
   {% endcall %}
   ========================================================================== #}
{% macro action_panel(id="action-panel") %}
<aside class="action-panel" id="{{ id }}">
  {{ caller() }}
</aside>
{% endmacro %}

{% macro action_row() %}
<div class="action-panel__row">
  {{ caller() }}
</div>
{% endmacro %}


{# ==========================================================================
   NAV BAR (back/forward navigation)

   {{ ui.nav_bar() }}
   {% call ui.nav_bar() %}
     <span>Custom center content</span>
   {% endcall %}
   ========================================================================== #}
{% macro nav_bar(center_content=none) %}
<nav class="nav-bar">
  <button class="nav-bar__btn" onclick="history.back()" title="Back">←</button>
  {% if center_content %}
  {{ center_content }}
  {% elif caller %}
  {{ caller() }}
  {% endif %}
  <button class="nav-bar__btn" onclick="history.forward()" title="Forward">→</button>
</nav>
{% endmacro %}


{# ==========================================================================
   SOURCE PANEL

   {{ ui.source_panel(source) }}
   ========================================================================== #}
{% macro source_panel(source) %}
{% if source %}
<section class="source-panel" id="source-panel">
  <div class="source-panel__header">
    <div class="source-panel__info">
      <span class="source-panel__label">Source:</span>
      <span class="source-panel__title">{{ source.title or 'Untitled' }}</span>
    </div>
    <button class="source-panel__toggle" onclick="toggleSourcePanel()" id="source-toggle">[+]</button>
  </div>
  <div class="source-panel__meta">{{ source.domain }} · {{ source.archived_at.strftime('%b %d') if source.archived_at else '' }}</div>
  <div class="source-panel__details" id="source-details" style="display: none;">
    {% if source.description %}
    <p class="source-panel__description">{{ source.description }}</p>
    {% endif %}
    <a href="{{ source.url }}" target="_blank" class="source-panel__link">Open original</a>
  </div>
</section>
{% endif %}
{% endmacro %}


{# ==========================================================================
   TOOLBAR

   {% call ui.toolbar() %}
     {{ ui.button("Add", sm=true) }}
     {{ ui.toolbar_spacer() }}
     {{ ui.toolbar_info("5 items") }}
   {% endcall %}
   ========================================================================== #}
{% macro toolbar() %}
<div class="toolbar">
  {{ caller() }}
</div>
{% endmacro %}

{% macro toolbar_spacer() %}
<span class="toolbar__spacer"></span>
{% endmacro %}

{% macro toolbar_info(text) %}
<span class="toolbar__info">{{ text }}</span>
{% endmacro %}


{# ==========================================================================
   STATUS BAR

   {{ ui.status_bar("Saved", hint="Ctrl+S") }}
   ========================================================================== #}
{% macro status_bar(status_text, hint=none, status_id="save-status") %}
<div class="status-bar">
  <span class="status-bar__text" id="{{ status_id }}">{{ status_text }}</span>
  {% if hint %}
  <span class="status-bar__hint">{{ hint }}</span>
  {% endif %}
</div>
{% endmacro %}


{# ==========================================================================
   BADGE

   {{ ui.badge("video") }}
   ========================================================================== #}
{% macro badge(type) %}
<span class="badge">[{{ type | upper }}]</span>
{% endmacro %}


{# ==========================================================================
   LAYOUT 2-COLUMN

   {% call ui.layout_2col() %}
     <div>Left column</div>
     <div>Right column</div>
   {% endcall %}

   {% call ui.layout_2col(sidebar=true) %}
     <div>Main content</div>
     <div>Sidebar</div>
   {% endcall %}
   ========================================================================== #}
{% macro layout_2col(sidebar=false) %}
<div class="layout-2col {{ 'layout-2col--sidebar' if sidebar else '' }}">
  {{ caller() }}
</div>
{% endmacro %}


{# ==========================================================================
   CONVEYOR ITEM (bookmark-manager specific)

   {% call ui.conveyor_item() %}
     <h2 class="conveyor-item__title">Title</h2>
     <div class="conveyor-item__meta">Meta info</div>
     <p class="conveyor-item__description">Description</p>
   {% endcall %}
   ========================================================================== #}
{% macro conveyor_item() %}
<section class="conveyor-item">
  {{ caller() }}
</section>
{% endmacro %}


{# ==========================================================================
   NEXT UP QUEUE (bookmark-manager specific)

   {{ ui.next_up(items) }}
   ========================================================================== #}
{% macro next_up(items) %}
<div class="next-up">
  <div class="next-up__header">Next Up</div>
  {% for item in items %}
  <div class="next-up__item" data-id="{{ item.id }}">
    {% if item.video_id %}<span class="badge">[VID]</span>{% endif %}
    {% if item.pinned %}<span class="badge">[PIN]</span>{% endif %}
    {% if item.is_thesis %}<span class="badge">[DOC]</span>{% endif %}
    <span class="next-up__title">{{ item.title or 'Untitled' }}</span>
    {% if item.expires_at %}
    <span class="next-up__timer" data-expires="{{ item.expires_at.isoformat() }}Z">{{ item.expires_at | expiry }}</span>
    {% endif %}
  </div>
  {% endfor %}
</div>
{% endmacro %}


{# ==========================================================================
   PRIORITY LIST
   Reorderable list with up/down arrow buttons

   {{ ui.priority_list(priorities, id="priority-list") }}

   Where priorities = [{"id": 1, "name": "Thesis", "meta": "2 sessions"}, ...]
   ========================================================================== #}
{% macro priority_list(items, id="priority-list") %}
<div class="priority-list" id="{{ id }}">
  {% for item in items %}
  <div class="priority-list__item" data-id="{{ item.id }}">
    <span class="priority-list__rank">{{ loop.index }}</span>
    <span class="priority-list__name">{{ item.name }}</span>
    {% if item.meta %}
    <span class="priority-list__meta">{{ item.meta }}</span>
    {% endif %}
    <span class="priority-list__arrows">
      <button class="priority-list__arrow" data-dir="up" onclick="movePriority(this, 'up')" {{ 'disabled' if loop.first }}>&#9650;</button>
      <button class="priority-list__arrow" data-dir="down" onclick="movePriority(this, 'down')" {{ 'disabled' if loop.last }}>&#9660;</button>
    </span>
  </div>
  {% endfor %}
</div>
{% endmacro %}


{# ==========================================================================
   DRIFT ALERT
   Insight card showing priority misalignment
   ========================================================================== #}
{% macro drift_alert(priority, rank, pct, instead, instead_rank, instead_pct, weeks=0) %}
<div class="drift-alert">
  <div class="drift-alert__header">Biggest drift</div>
  <div class="drift-alert__main">
    <strong>{{ priority }}</strong> is priority #{{ rank }} but got
    <span class="drift-alert__stat">{{ pct }}%</span> of sessions.
    <strong>{{ instead }}</strong> (#{{ instead_rank }}) got
    <span class="drift-alert__stat">{{ instead_pct }}%</span>.
  </div>
  {% if weeks > 1 %}
  <div class="drift-alert__context">
    This is week {{ weeks }} of {{ priority }} being deprioritized.
  </div>
  {% endif %}
</div>
{% endmacro %}
